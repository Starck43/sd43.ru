{% load static %}
{% load custom_tags %}
{% load i18n admin_urls static %}

<div class="js-inline-admin-formset inline-group portfolio-images-grid"
     id="{{ inline_admin_formset.formset.prefix }}-group"
     data-inline-type="stacked"
     data-inline-formset="{{ inline_admin_formset.inline_formset_data }}"
>
    <fieldset class="module {{ inline_admin_formset.classes }}">
        {% if inline_admin_formset.opts.verbose_name_plural %}
            <h2>{{ inline_admin_formset.opts.verbose_name_plural|capfirst }}</h2>
        {% endif %}

        <input type="hidden" name="images_order" id="images-order">
        {{ inline_admin_formset.formset.management_form }}
        {{ inline_admin_formset.formset.non_form_errors }}

        <!-- Grid контейнер -->
        <div class="images-grid-container" data-is-draggable="true" data-initialized="false">
            {% for inline_admin_form in inline_admin_formset %}
                {% with inline_admin_form.original as image_obj %}
                    <div class="image-grid-item{% if image_obj or inline_admin_form.show_url %} has-original{% endif %}{% if forloop.last and inline_admin_formset.has_add_permission %} new-form empty-item last-related{% endif %}"
                         id="{{ inline_admin_formset.formset.prefix }}-{% if not forloop.last %}{{ forloop.counter0 }}{% else %}empty{% endif %}"
                         data-image-id="{{ image_obj.id }}"
                    >

                        <!-- Скрытые поля Django формы -->
                        <div class="django-fields" style="display: none;">
                            {{ inline_admin_form.form }}
                        </div>

                        <!-- Превью изображения -->
                        {% if image_obj and image_obj.file %}
                            <div class="image-thumbnail" data-image-id="{{ image_obj.id }}">
                                <a href="{{ image_obj.file.url }}" target="_blank" class="image-container image-link">
                                    {% if image_obj.file_thumb %}
                                        {# Используем thumb.html для превью #}
                                        {% with image_obj.file as thumb %}
                                            {% include "exhibition/thumb.html" %}
                                        {% endwith %}
                                    {% else %}
                                        <img class="lazyloaded"
                                             src="{{ image_obj.file.url }}"
                                             loading="lazy"
                                             alt="{{ image_obj.title|default:'Изображение' }}">
                                    {% endif %}
                                </a>
                                <div class="image-title">
                                    {% if image_obj.title %}
                                        {{ image_obj.title|truncatechars:20 }}
                                    {% elif image_obj.file %}
                                        <!-- Показываем имя файла в нижнем регистре -->
                                        {{ image_obj.file.name|filename|lower }}
                                    {% else %}
                                        <span class="no-title">новое фото</span>
                                    {% endif %}
                                </div>
                                <!-- Input file для существующих фото -->
                                <input type="file"
                                       accept="image/*"
                                       name="{{ inline_admin_form.form.file.html_name }}"
                                       data-sort="{{ image_obj.sort }}"
                                       style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; z-index: 1;"
                                >
                            </div>

                        {% else %}

                            <div class="image-thumbnail empty-thumbnail">
                                <div class="image-container no-image">
                                    <i class="fas fa-plus"></i>
                                    <div class="drag-drop-hint">Или перетащите файл</div>
                                </div>
                                <div class="image-title">Новое фото</div>

                                {{ inline_admin_form.form.file }}
                            </div>

                        {% endif %}

                        <!-- Действия -->
                        <div class="image-actions">
                            {% if image_obj %}
                                <a href="{% url inline_admin_form.model_admin.opts|admin_urlname:'change' image_obj.pk|admin_urlquote %}"
                                   class="button edit-button" title="Изменить">
                                    <i class="fas fa-edit"></i>
                                </a>

                                {% if inline_admin_formset.formset.can_delete and inline_admin_formset.has_delete_permission %}
                                    <label class="delete-checkbox" title="Удалить">
                                        {{ inline_admin_form.deletion_field.field }}
                                        <span class="delete-icon"><i class="fas fa-trash"></i></span>
                                    </label>
                                {% endif %}
                            {% endif %}
                        </div>

                        <!-- Индикатор сортировки (только для существующих фото) -->
                        {% if image_obj %}
                            <div class="sort-indicator">
                                <i class="fas fa-arrows-alt"></i>
                            </div>
                        {% endif %}
                    </div>
                {% endwith %}
            {% endfor %}
        </div>

        {% if inline_admin_formset.has_add_permission %}
            {% with inline_admin_formset.formset.empty_form as empty_form %}
                <div class="empty-form-template" style="display:none">
                    <div class="image-grid-item new-form empty-item">
                        <!-- ВСЕ django-поля -->
                        <div class="django-fields" style="display:none">
                            {{ empty_form }}
                        </div>

                        <div class="image-thumbnail empty-thumbnail">
                            <div class="image-container no-image">
                                <i class="fas fa-plus"></i>
                                <div class="drag-drop-hint">Или перетащите файл</div>
                            </div>
                            <div class="image-title">Новое фото</div>

                            {# ВАЖНО: используем django input #}
                            {{ empty_form.file }}
                        </div>

                        <div class="image-actions"></div>
                    </div>
                </div>
            {% endwith %}
        {% endif %}

    </fieldset>
</div>

<!-- Кнопки управления всеми элементами -->
<div class="image-management-buttons">
    <button type="button" class="btn btn-toggle-selection" id="toggleSelection">
        <i class="fas fa-check-square me-1"></i> <span class="btn-text">Выбрать все</span>
    </button>
</div>

<!-- Информационная панель -->
<div class="images-info-panel">
    <i class="fas fa-info-circle"></i>
    <strong>Инструкция:</strong>
    <ul class="mb-0">
        <li>Нажмите на фото для замены изображения</li>
        <li>Используйте кнопку <i class="fas fa-edit"></i> для редактирования названия и сортировки</li>
        <li>Используйте кнопку <i class="fas fa-trash"></i> для удаления фото</li>
        <li>Кнопка "Выбрать все" переключает выделение всех фото</li>
        <li>Перетаскивайте фото для изменения порядка</li>
        <li>Перетащите файл на элемент "Новое фото" для загрузки</li>
    </ul>
</div>
