{% extends "admin/base_site.html" %}
{% load i18n admin_urls static custom_tags %}

{% block extrastyle %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'admin/css/export.min.css' %}">
    <style>
		.export-header {
			border-bottom: 1px solid #dee2e6;
			padding-bottom: 15px;
			margin-bottom: 20px;
		}
    </style>
{% endblock %}

{% block breadcrumbs %}
    <div class="breadcrumbs">
        <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
        ‚Ä∫ <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
        ‚Ä∫ <a href="{% url opts|admin_urlname:'changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>
        ‚Ä∫ <a href="{% url opts|admin_urlname:'change' exhibition.pk %}">{{ exhibition.title|truncatechars:30 }}</a>
        ‚Ä∫ {{ title }}
    </div>
{% endblock %}

{% block content %}
    <div class="jury-export-compact">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="export-header">
            <h1>{{ title }}</h1>
            <p class="text-muted">
                {{ exhibition.date_start|date:"d.m.Y" }} ‚Äì {{ exhibition.date_end|date:"d.m.Y" }}
                {% if exhibition.location %} ‚Ä¢ {{ exhibition.location }}{% endif %}
            </p>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="row stats-cards mb-4">
            <div class="col-md-3 col-6 mb-3">
                <div class="stat-card">
                    <div class="stat-value text-primary">{{ report_data.total_stats.total_jury }}</div>
                    <div class="stat-label">–ß–ª–µ–Ω–æ–≤ –∂—é—Ä–∏</div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="stat-card">
                    <div class="stat-value text-success">{{ report_data.total_stats.total_nominations }}</div>
                    <div class="stat-label">–ù–æ–º–∏–Ω–∞—Ü–∏–π</div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="stat-card">
                    <div class="stat-value text-warning">{{ report_data.total_stats.total_projects }}</div>
                    <div class="stat-label">–ü—Ä–æ–µ–∫—Ç–æ–≤</div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="stat-card">
                    <div class="stat-value text-danger">{{ report_data.total_stats.total_ratings }}</div>
                    <div class="stat-label">–û—Ü–µ–Ω–æ–∫ –≤—Å–µ–≥–æ</div>
                </div>
            </div>
        </div>

        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
        <div class="export-actions mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-file-excel text-success me-2"></i>–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</h5>
                    <p class="card-text text-muted mb-3">
                        –§–∞–π–ª –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–∞—á–∞–Ω –≤ –ø–∞–ø–∫—É "–ó–∞–≥—Ä—É–∑–∫–∏" –≤–∞—à–µ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞.
                    </p>

                    <!-- –í–ê–ñ–ù–û: —Ñ–æ—Ä–º–∞ –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å enctype –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ -->
                    <form method="post" id="exportForm" class="row g-3 align-items-end">
                        {% csrf_token %}
                        <!-- –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ -->
                        <input type="hidden" name="export_excel" value="1">

                        <div class="col-12 col-md-6">
                            <label for="filenameInput" class="form-label">–ò–º—è —Ñ–∞–π–ª–∞:</label>
                            <input type="text"
                                   name="filename"
                                   id="filenameInput"
                                   class="form-control"
                                   value="–æ—Ü–µ–Ω–∫–∏_–∂—é—Ä–∏_{{ exhibition.slug }}"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞"
                            >
                        </div>
                        <div class="col-12 col-md-6">
                            <button type="submit" class="btn btn-success btn-lg w-100" id="exportBtn">
                                <i class="fas fa-download me-2"></i> –°–∫–∞—á–∞—Ç—å Excel —Ñ–∞–π–ª
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>


        <!-- –ñ—é—Ä–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ -->
        {% if report_data.not_voted_jury %}
            <div class="not-voted-list">
                <h5 class="mb-3">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    –ñ—é—Ä–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞ –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã:
                    <span class="badge bg-warning text-dark ms-2">
                        {{ report_data.not_voted_jury|length }}
                    </span>
                </h5>

                <div class="row">
                    {% for jury_id, jury_data in report_data.not_voted_jury.items %}
                        <div class="col-12 col-lg-6 mb-3">
                            <div class="card border-warning">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-user-circle text-warning me-2"></i>
                                            {{ jury_data.jury.name }}
                                        </h6>
                                        <span class="badge bg-danger rounded-pill">
                                            {{ jury_data.total_missing }}
                                        </span>
                                    </div>

                                    <p class="card-text small text-muted mb-2">
                                        –ù–µ –æ—Ü–µ–Ω–∏–ª {{ jury_data.total_missing }}
                                        –ø—Ä–æ–µ–∫—Ç{{ jury_data.total_missing|pluralize:"–æ–≤,–∞" }}
                                    </p>

                                    <!-- –ò–∑–º–µ–Ω—è–µ–º data-–∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è —á–∏—Å—Ç–æ–≥–æ JS -->
                                    <button type="button"
                                            class="btn btn-sm btn-outline-warning w-100 collapse-btn"
                                            data-toggle="collapse"
                                            data-target="#juryDetails{{ jury_id }}"
                                            aria-expanded="false"
                                            aria-controls="juryDetails{{ jury_id }}">
                                        <i class="fas fa-chevron-down me-1"></i>
                                        <span class="btn-text">–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏</span>
                                    </button>

                                    <!-- –ú–µ–Ω—è–µ–º –∫–ª–∞—Å—Å —Å .collapse –Ω–∞ .collapse-content -->
                                    <div class="collapse-content mt-2" id="juryDetails{{ jury_id }}"
                                         style="display: none;">
                                        <div class="alert alert-light border">
                                            <h6 class="alert-heading mb-2">–î–µ—Ç–∞–ª–∏ –ø–æ –Ω–æ–º–∏–Ω–∞—Ü–∏—è–º:</h6>
                                            {% for nom_data in jury_data.nominations %}
                                                <div class="d-flex justify-content-between align-items-center mb-1 pb-1 border-bottom">
                                                    <div>
                                                        <span class="fw-medium">{{ nom_data.nomination.title }}</span>
                                                    </div>
                                                    <div class="text-end">
                                                        <span class="badge {% if nom_data.missing > 0 %}bg-danger{% else %}bg-success{% endif %}">
                                                            {{ nom_data.voted }}/{{ nom_data.total }}
                                                        </span>
                                                    </div>
                                                </div>
                                            {% endfor %}

                                            <div class="mt-2 pt-2 border-top">
                                                <small class="text-muted">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    –í—Å–µ–≥–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å
                                                    –æ—Ü–µ–Ω–µ–Ω–æ: {{ jury_data.nominations|sum_total:"total" }} –ø—Ä–æ–µ–∫—Ç–æ–≤
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <!-- –¢–∞–±–ª–∏—Ü–∞ –æ—Ü–µ–Ω–æ–∫ -->
        {% if report_data.nominations %}
            <div class="table-responsive mb-5">
                <table class="table-jury">
                    <thead>
                    <tr>
                        <th style="text-align: left">
                            <span>–ü—Ä–æ–µ–∫—Ç</span>
                            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø—Ä–æ–µ–∫—Ç–æ–≤ -->
                            <form method="get">
                                <select name="limit"
                                        id="limit"
                                        onchange="this.form.submit()"
                                >
                                    <option value="3" {% if projects_per_nomination == 3 %}selected{% endif %}>
                                        3
                                    </option>
                                    <option value="5" {% if projects_per_nomination == 5 %}selected{% endif %}>
                                        5
                                    </option>
                                    <option value="10" {% if projects_per_nomination == 10 %}selected{% endif %}>
                                        10
                                    </option>
                                    <option value="50" {% if projects_per_nomination == 50 %}selected{% endif %}>
                                        –í—Å–µ
                                    </option>
                                </select>
                            </form>
                        </th>
                        {% for jury in report_data.jury_list %}
                            <th>
                                {% with full_name=jury.name|default:jury.user_name %}
                                    {% if " " in full_name %}
                                        <!-- –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–µ–ª, —Ä–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ –¥–≤–µ —Å—Ç—Ä–æ–∫–∏ -->
                                        {% with first=full_name.split.0 last=full_name.split.1 %}
                                            {{ first }}<br>{{ last }}
                                        {% endwith %}
                                    {% else %}
                                        <!-- –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–æ–±–µ–ª–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å -->
                                        {{ full_name }}
                                    {% endif %}
                                {% endwith %}
                            </th>
                        {% endfor %}
                        <th>–°—É–º–º–∞ –±–∞–ª–ª–æ–≤</th>
                    </tr>
                    </thead>

                    <tbody>
                    {% for nomination in report_data.nominations %}
                        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–æ–º–∏–Ω–∞—Ü–∏–∏ -->
                        <tr>
                            <td colspan="{{ report_data.jury_list|length|add:2 }}" class="nomination-header">
                                <span class="nomination-title">{{ nomination.title }}</span>
                                <span class="nomination-stats">
                                    {{ nomination.all_projects }} –ø—Ä–æ–µ–∫—Ç{{ nomination.all_projects|custom_pluralize }}
                                </span>
                            </td>
                        </tr>

                        <!-- –¢–æ–ø –ø—Ä–æ–µ–∫—Ç—ã -->
                        {% for project in nomination.top_projects %}
                            <tr class="project-row">
                                <td class="project-name">
                                    <div class="project-info">
                                        {% if forloop.first %}
                                            <span class="medal-badge gold">1</span>
                                        {% elif forloop.counter == 2 %}
                                            <span class="medal-badge silver">2</span>
                                        {% elif forloop.counter == 3 %}
                                            <span class="medal-badge bronze">3</span>
                                        {% endif %}
                                        <div>
                                            <div class="project-title">{{ project.portfolio }}</div>
                                            <div class="project-author">{{ project.portfolio.owner.name }}</div>
                                        </div>
                                    </div>
                                </td>

                                {% for jury in report_data.jury_list %}
                                    {% with score=project.jury_scores|get_item:jury.id %}
                                        <td class="jury-score {% if score %}positive{% else %}empty{% endif %}">
                                            {{ score|default:'‚Äî' }}
                                        </td>
                                    {% endwith %}
                                {% endfor %}

                                <td class="total-score">{{ project.total_score|default:'‚Äî' }}</td>
                            </tr>
                        {% endfor %}

                        <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ -->
                        {% if nomination.other_projects %}
                            <tr>
                                <td colspan="{{ report_data.jury_list|length|add:2 }}" class="text-center py-2">
                                    <button type="button" class="show-all-btn"
                                            onclick="toggleProjects('nomination-{{ forloop.counter }}')">
                                        <i class="fas fa-chevron-down me-1"></i>
                                        –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã (–µ—â–µ {{ nomination.other_projects|length }})
                                    </button>
                                </td>
                            </tr>

                            <!-- –°–∫—Ä—ã—Ç—ã–µ –ø—Ä–æ–µ–∫—Ç—ã -->
                            <tbody id="nomination-{{ forloop.counter }}" class="hidden-projects">
                            {% for project in nomination.other_projects %}
                                <tr class="project-row">
                                    <td class="project-name" style="padding-left: 25px;">
                                        <div class="project-info">
                                            <div style="width: 24px;"></div>
                                            <div>
                                                <div class="project-title">{{ project.portfolio }}</div>
                                                <div class="project-author">{{ project.portfolio.owner.name }}</div>
                                            </div>
                                        </div>
                                    </td>

                                    {% for jury in report_data.jury_list %}
                                        {% with score=project.jury_scores|get_item:jury.id %}
                                            <td class="jury-score {% if score %}positive{% else %}empty{% endif %}">
                                                {{ score|default:"‚Äî" }}
                                            </td>
                                        {% endwith %}
                                    {% endfor %}

                                    <td class="total-score">{{ project.total_score|default:"‚Äî" }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        {% endif %}

                        <tr>
                            <td colspan="{{ report_data.jury_list|length|add:2 }}" style="height: 20px;"></td>
                        </tr>
                    {% endfor %}

                    <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ -->
                    <tr>
                        <td style="text-align: left" class="grand-total"><span>–í–°–ï–ì–û –û–¶–ï–ù–û–ö:</span></td>
                        {% for jury in report_data.jury_list %}
                            {% with stats=report_data.jury_stats|get_item:jury.id %}
                                <td class="grand-total">
                                    {{ stats.ratings_count }}
                                </td>
                            {% endwith %}
                        {% endfor %}
                        <td class="grand-total"></td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π -->
            {% with has_winners=report_data.nominations|has_voted_winners %}
                {% if has_winners %}
                    <div class="mb-5">
                        <h4 class="mb-3"><i class="fas fa-trophy text-warning me-2"></i>–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –ø–æ –Ω–æ–º–∏–Ω–∞—Ü–∏—è–º</h4>
                        <div class="table-responsive">
                            <table class="winners-table">
                                <thead>
                                <tr>
                                    <th style="width: 30%;">–ù–æ–º–∏–Ω–∞—Ü–∏—è</th>
                                    <th style="width: 50%;">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å</th>
                                    <th style="width: 20%;">–ë–∞–ª–ª—ã</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for nomination in report_data.nominations %}
                                    {% if nomination.winners %}
                                        <tr>
                                            <td><strong>{{ nomination.title }}</strong></td>
                                            <td>
                                                {% for winner in nomination.winners %}
                                                    <div class="winner-info {% if not forloop.first %}mt-3{% endif %}">
                                                        <span class="winner-medal {{ winner.medal }}">üèÜ</span>
                                                        <div>
                                                            <div><strong>{{ winner.portfolio.title }}</strong></div>
                                                            <div class="text-muted small">{{ winner.portfolio.owner.name }}</div>
                                                            {% if nomination.winners|length > 1 %}
                                                                <div class="text-warning small mt-1">
                                                                    <i class="fas fa-equals me-1"></i>–ï—â–µ {{ nomination.winners|length|add:"-1" }}
                                                                    –ø—Ä–æ–µ–∫—Ç{{ nomination.winners|length|add:"-1"|pluralize:"–æ–≤,–∞" }}
                                                                    —Å —Ç–∞–∫–∏–º –∂–µ –±–∞–ª–ª–æ–º
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </td>
                                            <td>
                                                {% for winner in nomination.winners %}
                                                    <div class="winner-score {% if not forloop.first %}mt-3{% endif %}">
                                                        {{ winner.score }}
                                                        {% if nomination.winners|length > 1 %}
                                                            <div class="text-muted small">(—Ä–∞–≤–Ω—ã–µ)</div>
                                                        {% endif %}
                                                    </div>
                                                {% endfor %}
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endif %}
            {% endwith %}

        {% else %}
            <!-- –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö -->
            <div class="alert alert-info">
                <h5 class="alert-heading"><i class="fas fa-info-circle mr-1"></i>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h5>
                <p>–î–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:</p>
                <ul class="mb-0">
                    <li>–ù–∞–∑–Ω–∞—á–∏—Ç—å –∂—é—Ä–∏ –¥–ª—è –≤—ã—Å—Ç–∞–≤–∫–∏</li>
                    <li>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç—ã –≤ –≤—ã—Å—Ç–∞–≤–∫—É –∏ –ø—Ä–∏–≤—è–∑–∞—Ç—å –∏—Ö –∫ –Ω–æ–º–∏–Ω–∞—Ü–∏—è–º</li>
                    <li>–ñ—é—Ä–∏ –¥–æ–ª–∂–Ω—ã –ø—Ä–æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞–º</li>
                </ul>
            </div>
        {% endif %}

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="info-panel">
            <div class="info-title"><i class="fas fa-info-circle mr-1"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –æ—Ç—á–µ—Ç—É:</div>
            <div class="info-text">
                ‚Ä¢ –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–æ–µ–∫—Ç—ã —Å –æ—Ü–µ–Ω–∫–∞–º–∏ –∂—é—Ä–∏<br>
                ‚Ä¢ –û—Ü–µ–Ω–∫–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ—Ç –∂—é—Ä–∏, —É—á–∞—Å—Ç–≤—É—é—â–∏—Ö –≤ —ç—Ç–æ–π –≤—ã—Å—Ç–∞–≤–∫–µ<br>
                ‚Ä¢ –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ø-{{ projects_per_nomination }} –ø—Ä–æ–µ–∫—Ç–∞ –≤ –∫–∞–∂–¥–æ–π –Ω–æ–º–∏–Ω–∞—Ü–∏–∏<br>
                ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–µ–ª–µ–∫—Ç–æ—Ä –≤—ã—à–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
            </div>
        </div>

        <!-- –ù–∞–∑–∞–¥ -->
        <div class="mt-4 text-center">
            <a href="{% url opts|admin_urlname:'change' exhibition.pk %}" class="btn btn-outline-primary me-2">
                <i class="fas fa-arrow-left me-2"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã—Å—Ç–∞–≤–∫–µ
            </a>
            <a href="{% url opts|admin_urlname:'changelist' %}" class="btn btn-link text-muted">
                –ö —Å–ø–∏—Å–∫—É –≤—Å–µ—Ö –≤—ã—Å—Ç–∞–≤–æ–∫
            </a>
        </div>
    </div>
{% endblock %}

{% block extrajs %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
            const exportBtn = document.getElementById('exportBtn');
            const exportForm = document.getElementById('exportForm');

            if (exportBtn && exportForm) {
                exportForm.addEventListener('submit', function (e) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                    showDownloadNotification();

                    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
                    const originalHTML = exportBtn.innerHTML;
                    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–∞...';
                    exportBtn.disabled = true;

                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 6 —Å–µ–∫—É–Ω–¥
                    setTimeout(() => {
                        exportBtn.innerHTML = originalHTML;
                        exportBtn.disabled = false;
                    }, 6000);
                });
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏
            function showDownloadNotification() {
                // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                const notification = document.createElement('div');
                notification.className = 'download-notification';
                notification.innerHTML = `
                    <div class="notification-content">
                        <div class="notification-title d-flex align-center">
                            <i class="fas fa-info-circle text-primary mr-2"></i>–ù–∞—á–∞—Ç–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
                        </div>
                        <div class="notification-message mt-3 ml-1">
                            –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É "–ó–∞–≥—Ä—É–∑–∫–∏" –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ.<br>
                            –ï—Å–ª–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞—á–∞–ª–æ—Å—å, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞.
                        </div>
                    </div>
                `;

                document.body.appendChild(notification);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 5000);
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è toggle collapse
            function toggleCollapse(button) {
                const targetId = button.getAttribute('data-target').replace('#', '');
                const content = document.getElementById(targetId);
                const icon = button.querySelector('i');
                const textSpan = button.querySelector('.btn-text');

                if (!content) return;

                // –ó–∞–ø—Ä–µ—â–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∫–ª–∏–∫–∏ –≤–æ –≤—Ä–µ–º—è –∞–Ω–∏–º–∞—Ü–∏–∏
                if (button.classList.contains('animating')) return;
                button.classList.add('animating');

                const isExpanded = button.getAttribute('aria-expanded') === 'true';

                if (isExpanded) {
                    // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
                    content.style.maxHeight = content.scrollHeight + 'px';
                    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π reflow –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
                    void content.offsetHeight;

                    content.style.maxHeight = '0';
                    content.style.opacity = '0';

                    if (icon) {
                        icon.classList.remove('rotated');
                    }
                    if (textSpan) {
                        textSpan.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏';
                    }
                    button.setAttribute('aria-expanded', 'false');

                    setTimeout(() => {
                        content.classList.remove('show');
                        button.classList.remove('animating');
                    }, 300);
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
                    content.style.display = 'block';
                    content.style.maxHeight = '0';
                    content.style.opacity = '0';
                    content.classList.add('show');

                    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π reflow
                    void content.offsetHeight;

                    const fullHeight = content.scrollHeight;
                    content.style.maxHeight = fullHeight + 'px';
                    content.style.opacity = '1';

                    if (icon) {
                        icon.classList.add('rotated');
                    }
                    if (textSpan) {
                        textSpan.textContent = '–°–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏';
                    }
                    button.setAttribute('aria-expanded', 'true');

                    setTimeout(() => {
                        // –£–±–∏—Ä–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤—ã—Å–æ—Ç—É –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
                        if (content.style.maxHeight !== 'none') {
                            content.style.maxHeight = 'none';
                        }
                        button.classList.remove('animating');
                    }, 300);
                }
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö collapse-–∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.collapse-btn').forEach(button => {
                const targetId = button.getAttribute('data-target').replace('#', '');
                const content = document.getElementById(targetId);

                if (content) {
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    content.style.display = 'none';
                    content.style.overflow = 'hidden';
                    button.setAttribute('aria-expanded', 'false');

                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
                    button.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        toggleCollapse(this);
                    });
                }
            });


            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ (–Ω–∞ —Å–ª—É—á–∞–π –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞)
            let resizeTimer;
            window.addEventListener('resize', function () {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ collapse –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ
                document.querySelectorAll('.collapse-content.show').forEach(content => {
                    const button = document.querySelector(`[data-target="#${content.id}"]`);
                    if (button) {
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º max-height –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ
                        if (content.style.maxHeight !== 'none') {
                            content.style.maxHeight = content.scrollHeight + 'px';
                        }
                    }
                });

                // Debounce —Ä–µ—Å–∞–π–∑–∞
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    document.querySelectorAll('.collapse-content.show').forEach(content => {
                        if (content.style.maxHeight !== 'none') {
                            content.style.maxHeight = 'none';
                        }
                    });
                }, 250);
            });

            const previewBtn = document.getElementById('previewBtn');
            const previewInfo = document.getElementById('previewInfo');

            // –±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            if (previewBtn && previewInfo) {
                previewBtn.addEventListener('click', function () {
                    if (previewInfo.style.display === 'none') {
                        previewInfo.style.display = 'block';
                        this.innerHTML = '<i class="fas fa-eye-slash me-2"></i> –°–∫—Ä—ã—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä';
                    } else {
                        previewInfo.style.display = 'none';
                        this.innerHTML = '<i class="fas fa-eye me-2"></i> –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä';
                    }
                });
            }

            //  –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —è—á–µ–µ–∫ —Å –æ—Ü–µ–Ω–∫–∞–º–∏
            document.querySelectorAll('.jury-score.positive').forEach(cell => {
                const score = parseInt(cell.textContent);
                if (score >= 4) {
                    cell.classList.add('score-high');
                } else if (score >= 3) {
                    cell.classList.add('score-medium');
                }
            });

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
            function toggleProjects(nominationId) {
                const hiddenSection = document.getElementById(nominationId);
                const button = hiddenSection.previousElementSibling.querySelector('.show-all-btn');
                const icon = button.querySelector('i');

                if (hiddenSection.classList.contains('visible')) {
                    // –°–∫—Ä—ã–≤–∞–µ–º
                    hiddenSection.classList.remove('visible');
                    if (icon) {
                        icon.className = 'fas fa-chevron-down me-1';
                    }
                    button.innerHTML = button.innerHTML.replace('–°–∫—Ä—ã—Ç—å', '–ü–æ–∫–∞–∑–∞—Ç—å');
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º
                    hiddenSection.classList.add('visible');
                    if (icon) {
                        icon.className = 'fas fa-chevron-up me-1';
                    }
                    button.innerHTML = button.innerHTML.replace('–ü–æ–∫–∞–∑–∞—Ç—å', '–°–∫—Ä—ã—Ç—å');
                }
            }

            // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è onclick
            window.toggleProjects = toggleProjects;
        });
    </script>
{% endblock %}
