{% load l10n %}
{% load custom_tags %}

<form class="rating-form flex-content
             {% if not user_can_rate and not exhibition_ended%}disabled{% endif %}
             {% if exhibition_ended %}show-rating{% endif %}"
      method="{% if user_can_rate %}post{% else %}get{% endif %}"
      action="{% url 'rating:add-rating' %}"
      value="{% if user_rate %}{{ user_rate|floatformat:0 }}{% endif %}"
      name="rating"
      data-is-jury="{{ is_jury|yesno:'true,false' }}"
      data-user-authenticated="{{ user.is_authenticated|yesno:'true,false' }}"
      data-user-can-rate="{{ user_can_rate|yesno:'true,false' }}"
      data-exhibition-ended="{{ exhibition_ended|yesno:'true,false' }}"
>

    <div class="mb-2">
        <small class="text-muted">
            {{ rate_message }}
        </small>
    </div>

    {% csrf_token %}
    <input type="hidden" value="{{ portfolio.id }}" name="portfolio">

    {# Заголовок для жюри ТОЛЬКО когда они могут голосовать #}
    {% if is_jury and jury_voting_active %}
        <div class="rating-header d-flex align-center mb-2">
            <div class="jury-badge btn-sm ratio">
                <svg class="icon jury-icon">
                    <use xlink:href="#award-icon"></use>
                </svg>
            </div>
            <h4 class="m-0">Вы оцениваете как член жюри</h4>
        </div>
        <div class="mb-3">
            <small class="text-muted">
                * Вы можете менять оценку до {{ jury_deadline|date_with_declension }}
            </small>
        </div>
    {% endif %}

    <div class="total-rating-block d-flex align-items-center">
        <span class="me-2">
            {% if is_jury and jury_voting_active %}
                Выберите оценку:
            {% else %}
                Рейтинг:
            {% endif %}
        </span>

        <span class="rating centered"
              data-average="{{ average_rate }}"
              data-round-rate="{{ round_rate }}"
              data-extra-percent="{{ extra_rate_percent }}"
        >
            {% for choice in rating_form.star %}
                {{ choice.tag }}
                <label for="{{ choice.id_for_label }}" class="centered">
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                         width="22" height="22" viewBox="2 2 20 20" fill="white" stroke="#000"
                         stroke-linecap="butt" stroke-linejoin="round">
                        <defs>
                            <mask id="mask-white-{{ forloop.counter0 }}">
                                <polygon fill="#fff"
                                         points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                            </mask>
                        </defs>
                        <rect class="rect" width="100%" height="100%"
                              mask="url(#mask-white-{{ forloop.counter0 }})"></rect>
                    </svg>

                    {% if forloop.revcounter == round_rate and extra_rate_percent > 0 %}
                        <span class="partial-fill" style="width: {{ extra_rate_percent|unlocalize }}%"></span>
                    {% elif forloop.revcounter < round_rate %}
                        {# Полностью заполненные звезды #}
                        <span class="full-fill"></span>
                    {% endif %}

                </label>
            {% endfor %}
        </span>

        {# Средняя оценка #}
        {% if show_average and average_rate > 0 %}
            {% if not is_owner or exhibition_ended or is_jury or user.is_staff %}
                <span class="summary-score ms-2">
                    {{ average_rate|unlocalize }}
                </span>
            {% endif %}
        {% endif %}
    </div>

    {# Личная оценка пользователя #}
    {% if user_rate %}
        <div class="personal-rating-block d-flex align-items-center mt-2">
            <span class="me-2">Ваша оценка:</span>
            <b>{{ user_rate }}.0</b>
        </div>
    {% endif %}
</form>
