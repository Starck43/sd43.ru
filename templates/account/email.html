{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load i18n %}

{% block page_title %}{% trans "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Email –∞–¥—Ä–µ—Å–∞–º–∏" %}{% endblock %}

{% block content %}
    <div class="email-management">
        <h2 class="mb-4">üìß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ email –∞–¥—Ä–µ—Å–∞–º–∏</h2>

        {% if user.emailaddress_set.all %}
            <div class="current-emails mb-5">
                <h4 class="mb-3">–¢–µ–∫—É—â–∏–µ email –∞–¥—Ä–µ—Å–∞:</h4>

                <form action="{% url 'account_email' %}" class="email_list" method="post">
                    {% csrf_token %}

                    <div class="email-list">
                        {% for emailaddress in user.emailaddress_set.all %}
                            <div class="email-item card mb-3">
                                <div class="card-body">
                                    <div class="form-check">
                                        <input class="form-check-input"
                                               id="email_radio_{{ forloop.counter }}"
                                               type="radio"
                                               name="email"
                                               {% if emailaddress.primary or user.emailaddress_set.count == 1 %}checked="checked"{% endif %}
                                               value="{{ emailaddress.email }}"/>
                                        <label class="form-check-label" for="email_radio_{{ forloop.counter }}">
                                            <strong>{{ emailaddress.email }}</strong>

                                            {% if emailaddress.verified %}
                                                <span class="badge bg-success ms-2">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</span>
                                            {% else %}
                                                <span class="badge bg-warning ms-2">–ù–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</span>
                                            {% endif %}

                                            {% if emailaddress.primary %}
                                                <span class="badge bg-primary ms-2">–û—Å–Ω–æ–≤–Ω–æ–π</span>
                                            {% endif %}
                                        </label>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <div class="email-actions mt-4">
                        <button class="btn btn-outline-primary me-2" type="submit" name="action_primary">
                            –°–¥–µ–ª–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–º
                        </button>
                        <button class="btn btn-outline-warning me-2" type="submit" name="action_send">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                        </button>
                        <button class="btn btn-outline-danger" type="submit" name="action_remove">
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </form>
            </div>
        {% else %}
            <div class="alert alert-warning mb-5">
                <h5 class="alert-heading">‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ</h5>
                <p class="mb-0">
                    –£ –≤–∞—Å –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ email –∞–¥—Ä–µ—Å–∞.
                    –î–æ–±–∞–≤—å—Ç–µ email –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –∏ –¥—Ä—É–≥–∏—Ö –≤–∞–∂–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π.
                </p>
            </div>
        {% endif %}

        <div class="add-email mt-5">
            <h4 class="mb-3">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π email</h4>

            <form method="post" action="{% url 'account_email' %}" class="add_email">
                {% csrf_token %}
                {{ form|crispy }}
                <button class="btn btn-primary" name="action_add" type="submit">
                    –î–æ–±–∞–≤–∏—Ç—å email
                </button>
            </form>
        </div>
    </div>

    <style>
		.email-management {
			max-width: 600px;
			margin: 0 auto;
		}

		.email-item {
			border-left: 4px solid #dee2e6;
		}

		.email-item .form-check-input:checked + label {
			font-weight: bold;
		}

		.email-actions {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
		}
    </style>
{% endblock %}

{% block extra_body %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è email
            var removeButtons = document.querySelectorAll('button[name="action_remove"]');
            removeButtons.forEach(function (button) {
                button.addEventListener('click', function (e) {
                    if (!confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π email –∞–¥—Ä–µ—Å?')) {
                        e.preventDefault();
                    }
                });
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ" —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö email
            var unverifiedExists = document.querySelectorAll('.badge.bg-warning').length > 0;
            var sendButton = document.querySelector('button[name="action_send"]');

            if (sendButton) {
                if (!unverifiedExists) {
                    sendButton.style.display = 'none';
                } else {
                    sendButton.style.display = 'inline-block';
                }
            }
        });
    </script>
{% endblock %}
