name: sd43 CI/CD

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

env:
  NODE_VERSION: '22'
  PROJECT_NAME: 'sd43'
  DOMAIN_NAME: 'sd43.ru'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ vars.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install npm dependencies
        run: |
          if [ -f "package.json" ]; then
            npm ci
            echo "âœ… npm dependencies installed"
          else
            echo "âš ï¸  No package.json found, skipping npm install"
          fi

      - name: Build assets
        run: |
          if [ -f "package.json" ]; then
            echo "ðŸ“¦ Building assets..."
            npm run build
          
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ ÑÐ±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÑˆÐ»Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾
            if [ -d "static/js" ] || [ -d "static/css" ]; then
              echo "âœ… Assets built successfully"
              find static/ -type f -name "*.js" -o -name "*.css" | head -10
            else
              echo "âš ï¸  No js/css directories found after build"
            fi
          else
            echo "â­ï¸  Skipping build - no package.json"
          fi

      - name: Copy built assets to server
        run: |
          REMOTE_USER="${{ vars.SSH_USER }}"
          REMOTE_HOST="${{ vars.SSH_HOST }}"
          REMOTE_DIR="/home/starck/domains/${{ env.DOMAIN_NAME }}"

          echo "ðŸ“¤ Copying built assets to server..."

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ static Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
          if [ -d "static" ]; then
            rsync -avz \
              static/ \
              "$REMOTE_USER@$REMOTE_HOST:$REMOTE_DIR/static/"
            echo "âœ… Static assets copied"
          else
            echo "âš ï¸  No static directory found"
          fi

      - name: Clean up node_modules
        run: |
          if [ -d "node_modules" ]; then
            echo "ðŸ§¹ Cleaning up node_modules..."
            rm -rf node_modules
            echo "âœ… node_modules removed"

            rm -f package-lock.json

            if [ ! -d "node_modules" ]; then
              echo "ðŸ“ Current directory size:"
              du -sh . || true
            fi
          else
            echo "ðŸ“ node_modules not found, nothing to clean"
          fi

      - name: Create rsync exclude file
        run: |
          cat > .deploy/rsync_exclude.txt << 'EOF'
          .git/
          .github/
          *.md
          *.jpg
          EOF
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ, ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
          find . -path "*/migrations/*.py" -not -name "__init__.py" 2>/dev/null | head -5 >> .deploy/rsync_exclude.txt || true
          find . -path "*/migrations/*.pyc" 2>/dev/null | head -5 >> .deploy/rsync_exclude.txt || true

      - name: Prepare deployment structure
        run: |
          REMOTE_USER="${{ vars.SSH_USER }}"
          REMOTE_HOST="${{ vars.SSH_HOST }}"
          REMOTE_DIR="/home/starck/domains/${{ env.DOMAIN_NAME }}"

          echo "ðŸš€ Preparing deployment to $REMOTE_DIR"

          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐºÐ¾Ñ€Ð½ÐµÐ²ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          ssh "$REMOTE_USER@$REMOTE_HOST" "
            if [ ! -d '$REMOTE_DIR' ]; then
              mkdir -p '$REMOTE_DIR'
              chown -R starck:starck '$REMOTE_DIR' 2>/dev/null || true
            fi
          "

      - name: Deploy .env file
        run: |
          REMOTE_USER="${{ vars.SSH_USER }}"
          REMOTE_HOST="${{ vars.SSH_HOST }}"
          REMOTE_DIR="/home/starck/domains/${{ env.DOMAIN_NAME }}"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ ÑÐµÐºÑ€ÐµÑ‚Ð°
          if [ -n "${{ secrets.PROD_ENV_FILE }}" ]; then
            echo "âœ… PROD_ENV_FILE secret found"
          
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¸ .env Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
            if ssh "$REMOTE_USER@$REMOTE_HOST" "[ -f '$REMOTE_DIR/.env' ]"; then
              echo "âš ï¸  .env already exists on server"
          
              # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ñ‚Ñƒ Ð¼Ð¾Ð´Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ñ„Ð°Ð¹Ð»Ð° Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
              SERVER_TIMESTAMP=$(ssh "$REMOTE_USER@$REMOTE_HOST" "stat -c %Y '$REMOTE_DIR/.env' 2>/dev/null || echo '0'")
              echo "   Server .env timestamp: $(date -d @$SERVER_TIMESTAMP 2>/dev/null || echo 'unknown')"
          
              # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ñ Ð½Ð¾Ð²Ñ‹Ð¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ñ‹Ð¼
              echo "${{ secrets.PROD_ENV_FILE }}" > /tmp/prod_env_tmp
          
              # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ñ‚Ñƒ ÑÐµÐºÑ€ÐµÑ‚Ð° (Ñ‚ÐµÐºÑƒÑ‰ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ ÐºÐ°Ðº proxy Ð´Ð»Ñ Ð²ÐµÑ€ÑÐ¸Ð¸ ÑÐµÐºÑ€ÐµÑ‚Ð°)
              SECRET_TIMESTAMP=$(date +%s)
              echo "   Secret timestamp: $(date -d @$SECRET_TIMESTAMP)"
          
              # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÑ‚ÑŒ
              if [ $SECRET_TIMESTAMP -gt $SERVER_TIMESTAMP ]; then
                echo "ðŸ“ Secret is newer, updating .env..."
          
                # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ diff Ð´Ð»Ñ Ð¿Ð¾Ð½Ð¸Ð¼Ð°Ð½Ð¸Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
                echo "--- Changes preview ---"
                echo "${{ secrets.PROD_ENV_FILE }}" | ssh "$REMOTE_USER@$REMOTE_HOST" "diff -u '$REMOTE_DIR/.env' -" || true
                echo "--- End preview ---"
          
                # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ„Ð°Ð¹Ð»
                ssh "$REMOTE_USER@$REMOTE_HOST" "cat > '$REMOTE_DIR/.env'" < /tmp/prod_env_tmp
          
                # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ timestamp Ð´Ð¾ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
                ssh "$REMOTE_USER@$REMOTE_HOST" "touch -m '$REMOTE_DIR/.env'"
          
                echo "âœ… .env updated with newer version"
              else
                echo "âœ… Server .env is newer or same age, preserving it"
                echo "   To force update, modify the secret in GitHub"
              fi
          
              rm -f /tmp/prod_env_tmp
            else
              echo "ðŸ“ Creating new .env file on server (first deploy)..."
              echo "${{ secrets.PROD_ENV_FILE }}" | ssh "$REMOTE_USER@$REMOTE_HOST" "cat > '$REMOTE_DIR/.env' && chmod 600 '$REMOTE_DIR/.env'"
              echo "âœ… New .env created"
            fi
          else
            echo "âš ï¸  WARNING: PROD_ENV_FILE secret is not set!"
            echo "Assuming .env already exists on server"
          fi

      - name: Sync files to server
        run: |
          REMOTE_USER="${{ vars.SSH_USER }}"
          REMOTE_HOST="${{ vars.SSH_HOST }}"
          REMOTE_DIR="/home/starck/domains/${{ env.DOMAIN_NAME }}"
          
          echo "ðŸ“¤ Syncing files to server..."
          
          # ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ
          rsync -avz \
            --delete \
            --exclude-from=.gitignore \
            --exclude-from=.deploy/rsync_exclude.txt \
            --chmod=Du=rwx,Dg=rx,Do=rx,Fu=rw,Fg=r,Fo=r \
            ./ \
            "$REMOTE_USER@$REMOTE_HOST:$REMOTE_DIR/"
          
          echo "âœ… Files synced successfully"

      - name: Run deployment script
        run: |
          REMOTE_USER="${{ vars.SSH_USER }}"
          REMOTE_HOST="${{ vars.SSH_HOST }}"
          REMOTE_DIR="/home/starck/domains/${{ env.DOMAIN_NAME }}"
          
          echo "ðŸ”„ Running deployment script..."
          
          ssh "$REMOTE_USER@$REMOTE_HOST" "
            set -e
            cd '$REMOTE_DIR'
          
            # Ð”ÐµÐ»Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¼
            chmod +x .deploy/deployment_script.sh 2>/dev/null || true
          
            # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹
            bash .deploy/deployment_script.sh \
              '${{ env.PROJECT_NAME }}' \
              '$REMOTE_DIR' \
              '${{ vars.DJANGO_ADMIN_EMAIL }}' \
              '${{ vars.DJANGO_ADMIN_SUPERUSER }}' \
              '${{ secrets.DJANGO_ADMIN_PASSWORD }}'
          "
          
          echo "âœ… Deployment script executed"

      - name: Verify deployment
        run: |
          REMOTE_USER="${{ vars.SSH_USER }}"
          REMOTE_HOST="${{ vars.SSH_HOST }}"
          
          echo "ðŸ” Verifying deployment..."
          
          ssh "$REMOTE_USER@$REMOTE_HOST" "
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ ÑÐµÑ€Ð²Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
            if systemctl is-active --quiet sd43.service; then
              echo 'âœ… Service sd43.service is running'
          
              # Ð‘Ñ‹ÑÑ‚Ñ€Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
              systemctl status sd43.service --no-pager | head -10
            else
              echo 'âŒ Service sd43.service is not running!'
              systemctl status sd43.service --no-pager
              exit 1
            fi
          
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¾ÐºÐµÑ‚
            if [ -S '/run/gunicorn/sd43.sock' ]; then
              echo 'âœ… Socket /run/gunicorn/sd43.sock exists'
              ls -la /run/gunicorn/sd43.sock
            else
              echo 'âš ï¸  Socket not found, checking service...'
            fi
          
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³
            if sudo nginx -t 2>/dev/null; then
              echo 'âœ… Nginx configuration is valid'
            fi
          "
          
          echo "ðŸŽ‰ Deployment completed successfully!"
